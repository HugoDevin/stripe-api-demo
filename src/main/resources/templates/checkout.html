<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>付款頁</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h2, h3 { margin-bottom: 10px; }

        form { max-width: 500px; }

        .stripe-row {
            display: flex;
            gap: 10px; /* 欄位間距 */
            margin-bottom: 15px;
        }

        .stripe-field {
            flex: none; /* 不自動拉伸 */
        }

        #card-number { width: 250px; }
        #card-expiry { width: 70px; }
        #card-cvc { width: 60px; }
        #postal-code { width: 80px; }

        label { display: block; font-weight: bold; margin-bottom: 5px; }

        #submit { padding: 8px 16px; font-size: 16px; }
        #payment-message { margin-top: 10px; color: red; }
    </style>
</head>
<body>
<h2>購買商品: <span th:text="${product}"></span></h2>
<h3>金額: $<span th:text="${amount / 100}"></span></h3>

<form id="payment-form">
    <div class="stripe-row">
        <div class="stripe-field">
            <label>卡號</label>
            <div id="card-number"></div>
        </div>
    </div>

    <div class="stripe-row">
        <div class="stripe-field">
            <label>到期日</label>
            <div id="card-expiry"></div>
        </div>
        <div class="stripe-field">
            <label>CVC</label>
            <div id="card-cvc"></div>
        </div>
        <div class="stripe-field">
            <label>郵遞區號</label>
            <div id="postal-code"></div>
        </div>
    </div>

    <button id="submit">付款</button>
    <p id="payment-message"></p>
</form>

<script th:inline="javascript">
    const stripe = Stripe([[${@environment.getProperty('stripe.publishable-key')}]]);

    const clientSecret = /*[[${clientSecret}]]*/ '';

    const elements = stripe.elements();

    const cardNumber = elements.create('cardNumber');
    cardNumber.mount('#card-number');

    const cardExpiry = elements.create('cardExpiry');
    cardExpiry.mount('#card-expiry');

    const cardCvc = elements.create('cardCvc');
    cardCvc.mount('#card-cvc');

    const postalCode = elements.create('postalCode');
    postalCode.mount('#postal-code');

    const form = document.getElementById('payment-form');
    const submitBtn = document.getElementById('submit');
    const paymentMessage = document.getElementById('payment-message');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;

        const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardNumber,
                billing_details: {
                    address: { postal_code: postalCode.value }
                }
            }
        });

        if (error) {
            paymentMessage.textContent = error.message;
            submitBtn.disabled = false;
        } else if (paymentIntent.status === 'succeeded') {
            paymentMessage.textContent = '付款成功！';
            window.location.href = '/orders';
        }
    });
</script>
</body>
</html>
